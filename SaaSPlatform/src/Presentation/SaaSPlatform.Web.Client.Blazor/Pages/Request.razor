@page "/"

<PageTitle>Azure SaaS Subscription Request</PageTitle>

@inject SubscriptionService SubscriptionService
@inject SubmissionSummaryState SummaryState
@inject NavigationManager NavigationManager

<div class="mx-auto max-w-3xl space-y-6">
    <div class="space-y-2 text-center">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-primary">Azure SaaS</p>
        <h1 class="section-heading">Subscription Request</h1>
        <p class="section-subheading">
            Fill out this form to request Azure infrastructure provisioning for your organization.
        </p>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="rounded-2xl border border-rose-200 bg-rose-50/80 p-4 text-rose-700">
            @_errorMessage
        </div>
    }

    <div class="surface-card">
        <EditForm class="space-y-5" Model="_form" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <div>
                <label class="block text-sm font-semibold text-slate-600" for="companyName">Company Name</label>
                <InputText id="companyName" class="mt-1 block w-full rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-slate-900 shadow-sm transition focus:border-primary focus:ring-2 focus:ring-primary/40" @bind-Value="_form.CompanyName" />
                <ValidationMessage For="@(() => _form.CompanyName)" class="mt-2 block text-sm text-rose-600" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-600" for="contactEmail">Contact Email</label>
                <InputText id="contactEmail" type="email" class="mt-1 block w-full rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-slate-900 shadow-sm transition focus:border-primary focus:ring-2 focus:ring-primary/40" @bind-Value="_form.ContactEmail" />
                <ValidationMessage For="@(() => _form.ContactEmail)" class="mt-2 block text-sm text-rose-600" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-600" for="contactPerson">Contact Person</label>
                <InputText id="contactPerson" class="mt-1 block w-full rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-slate-900 shadow-sm transition focus:border-primary focus:ring-2 focus:ring-primary/40" @bind-Value="_form.ContactPerson" />
                <ValidationMessage For="@(() => _form.ContactPerson)" class="mt-2 block text-sm text-rose-600" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-600" for="businessType">Business Type</label>
                <InputSelect id="businessType" class="mt-1 block w-full rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-slate-900 shadow-sm transition focus:border-primary focus:ring-2 focus:ring-primary/40" @bind-Value="_form.BusinessType">
                    <option value="">Select business type</option>
                    @foreach (var type in _businessTypes)
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => _form.BusinessType)" class="mt-2 block text-sm text-rose-600" />
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <button class="inline-flex items-center justify-center rounded-2xl bg-primary px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-primary/30 transition disabled:opacity-60" type="submit" disabled="@_isSubmitting">
                    @if (_isSubmitting)
                    {
                        <span class="mr-2 inline-block h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" aria-hidden="true"></span>
                    }
                    Submit Subscription Request
                </button>
                <button class="rounded-2xl border border-slate-200 px-5 py-3 text-sm font-semibold text-slate-600 transition hover:border-primary hover:text-primary" type="button" @onclick="NavigateToStatus">
                    Check Request Status
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private readonly string[] _businessTypes = new[]
    {
        "Technology", "Finance", "Healthcare", "Education", "Retail", "Manufacturing", "Other"
    };

    private CreateSubscriptionRequest _form = new();
    private bool _isSubmitting;
    private string? _errorMessage;

    private string _submitLabel => _isSubmitting ? "Submitting..." : "Submit Subscription Request";

    private async Task HandleValidSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            await SubscriptionService.CreateSubscriptionAsync(_form);

            SummaryState.LatestSummary = new SubmissionSummary
            {
                CompanyName = _form.CompanyName,
                ContactEmail = _form.ContactEmail,
                ContactPerson = _form.ContactPerson,
                BusinessType = _form.BusinessType,
                Status = "Pending Approval"
            };

            _form = new CreateSubscriptionRequest();
            NavigationManager.NavigateTo("/confirmation");
        }
        catch
        {
            _errorMessage = "Unable to submit your request right now. Please try again later.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateToStatus() => NavigationManager.NavigateTo("/status");
}
