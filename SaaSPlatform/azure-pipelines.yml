# Azure Pipelines - .NET Full-Stack SaaS Platform
# Build and Test Pipeline

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - SaaSPlatform/**

pr:
  branches:
    include:
      - main
      - develop

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '9.0.x'
  workingDirectory: 'SaaSPlatform'

stages:
  # ============================================
  # Stage 1: Build
  # ============================================
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: Build
        displayName: 'Build Solution'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: DotNetCoreCLI@2
            displayName: 'Restore Dependencies'
            inputs:
              command: 'restore'
              projects: '$(workingDirectory)/**/*.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build Solution'
            inputs:
              command: 'build'
              projects: '$(workingDirectory)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          # Publish build artifacts for potential deployment
          - task: DotNetCoreCLI@2
            displayName: 'Publish API'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(workingDirectory)/src/Api/SaaSPlatform.Api/SaaSPlatform.Api.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/api'
              zipAfterPublish: true

          - task: DotNetCoreCLI@2
            displayName: 'Publish Client Web'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(workingDirectory)/src/Presentation/SaaSPlatform.Web.Client/SaaSPlatform.Web.Client.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/client'
              zipAfterPublish: true

          - task: DotNetCoreCLI@2
            displayName: 'Publish Admin Web'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(workingDirectory)/src/Presentation/SaaSPlatform.Web.Admin/SaaSPlatform.Web.Admin.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/admin'
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'drop'
              publishLocation: 'Container'

  # ============================================
  # Stage 2: Test
  # ============================================
  - stage: Test
    displayName: 'Test'
    dependsOn: Build
    jobs:
      - job: Test
        displayName: 'Run Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: DotNetCoreCLI@2
            displayName: 'Restore Dependencies'
            inputs:
              command: 'restore'
              projects: '$(workingDirectory)/**/*.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Run Unit Tests'
            inputs:
              command: 'test'
              projects: '$(workingDirectory)/tests/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --collect:"XPlat Code Coverage" --results-directory $(Agent.TempDirectory)/TestResults'
              publishTestResults: true

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Code Coverage'
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml'
              failIfCoverageEmpty: false
